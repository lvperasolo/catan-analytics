<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Catan Analytics - tracking the rise and fall of CATAN empires">
    <meta name="author" content="Lucas V. Perasolo">
    <meta name="theme-color" content="#1a1a1a">
    
    <title>Catan analytics</title>
    
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600&family=Source+Sans+3:wght@300;400;500&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/d3-geo.v3.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
</head>
<body>
    <main>
        <div class="container catan-analytics">
            <header>
                <h1 class="name">Catan Analytics</h1>
                <p class="tagline">tracking the rise and fall of CATAN empires</p>

            <p class="bg-credit" style="font-size:0.9em; color:#ffffff; margin-top:0.5em; font-weight:600; text-shadow:0 2px 12px rgba(0,0,0,0.8), 0 4px 24px rgba(0,0,0,0.6), 0 0 4px rgba(0,0,0,0.5);">
                <span aria-label="artist credit" title="Background photo by Jotap√™">
                    background art by <a href="https://readymag.website/u926078996/5153336/" target="_blank" rel="noopener" style="color:#4da3ff; text-decoration:none; border-bottom:1px dotted #80bdff; font-weight:600; text-shadow:0 2px 12px rgba(0,0,0,0.8), 0 4px 24px rgba(0,0,0,0.6), 0 0 4px rgba(0,0,0,0.5);">Jotap√™</a> üñºÔ∏è
                </span>
            </p>
            </header>

            <section class="content">
                <div class="charts-container">
                    <div class="data-summary">
                        <h3>Summary Statistics</h3>
                        <div id="summary-stats" class="stats-grid">
                            <em>Loading statistics...</em>
                    </div>
                    </div>
                    <div class="chart-section">
                        <h3>Titles Over Time</h3>
                        <div class="chart-wrapper">
                            <canvas id="titlesChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-section">
                        <h3>Points Over Time</h3>
                        <div class="chart-wrapper">
                            <canvas id="pointsChart"></canvas>
                        </div>
                    </div>


                    <div class="chart-section globe-section">
                        <h3>Guests by Country</h3>
                        <div class="globe-container">
                            <svg class="globe-svg" id="globeSvg"></svg>
                            <div class="globe-tooltip" id="globeTooltip"></div>
                            <div class="country-info-panel" id="countryInfoPanel">
                                <div class="country-info-header">
                                    <h4 id="countryInfoTitle">Country Details</h4>
                                    <button class="close-btn" id="closeCountryInfo">√ó</button>
                                </div>
                                <div class="country-info-content">
                                    <div class="country-stat">
                                        <span class="stat-label">Country:</span>
                                        <span class="stat-value" id="countryName">-</span>
                                    </div>
                                    <div class="country-stat">
                                        <span class="stat-label">Visitors:</span>
                                        <span class="stat-value" id="countryVisitors">-</span>
                                    </div>
                                    <div class="country-stat">
                                        <span class="stat-label">Status:</span>
                                        <span class="stat-value" id="countryStatus">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        const playerColors = ['#00d4ff', '#ff0099', '#00ff88', '#ffffff', '#ffee00'];
        const globeColors = {base: '#2a2a2a', guests: ['#66d9ff', '#33c3ff', '#00aaff', '#0088ff']};
        
        let catanData = [], charts = {}, worldData, projection, path, svg, g, rotationInterval;

        const getPlayerColor = (name, all) => playerColors[all.indexOf(name) % playerColors.length];
        const sortSeasons = arr => arr.sort((a, b) => {
            const [qA, yA] = a.split(' '), [qB, yB] = b.split(' ');
            return yA !== yB ? yA - yB : qA.localeCompare(qB);
        });
        
        async function initGlobe() {
            try {
                const [world, guests] = await Promise.all([
                    fetch('data/countries-110m.json').then(r => r.json()),
                    fetch('data/guest_counts.json').then(r => r.json()).catch(() => ({countries: {}}))
                ]);
                
                worldData = world;
                worldData.objects.countries.geometries.forEach(c => {
                    c.properties = c.properties || {};
                    c.properties.guest_count = guests.countries?.[c.id]?.guest_count || 0;
                });
                
                setupGlobe();
            } catch (e) {
                document.querySelector('.globe-container').innerHTML = 
                    `<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#ef4444">Error: ${e.message}</div>`;
            }
        }

        const getCountryColor = c => c === 0 ? globeColors.base : globeColors.guests[Math.min(3, c <= 2 ? 0 : c <= 4 ? 1 : c <= 7 ? 2 : 3)];

        function setupGlobe() {
                svg = d3.select('#globeSvg');
                g = svg.append('g');

            const w = svg.node().clientWidth, h = svg.node().clientHeight;
            projection = d3.geoOrthographic()
                .scale(Math.min(w, h) * 0.4)
                .rotate([0, -30])
                .translate([w/2, h/2]);
            path = d3.geoPath().projection(projection);
            
                g.append('path')
                .datum(d3.geoGraticule())
                    .attr('d', path)
                    .style('fill', 'none')
                    .style('stroke', '#ccc')
                .style('stroke-opacity', 0.2);
            
            g.selectAll('.country')
                .data(topojson.feature(worldData, worldData.objects.countries).features)
                .enter().append('path')
                    .attr('class', 'country')
                    .attr('d', path)
                    .style('fill', d => getCountryColor(d.properties.guest_count || 0))
                    .style('stroke', '#334155')
                .on('mouseover', function(e, d) {
                    const c = d.properties.guest_count || 0, n = d.properties.name || d.properties.NAME || d.properties.ADMIN || 'Unknown';
                    d3.select(this).style('stroke', '#fff').style('stroke-width', 2);
                    d3.select('#globeTooltip')
                        .style('left', e.x+15+'px').style('top', e.y-15+'px')
                        .html(`<strong>${n}</strong><br><span style="color:#a8c5e0">${c===0?'No visitors':c===1?'1 visitor':c+' visitors'}</span>`)
                        .classed('show', true);
                })
                .on('mouseout', function() {
                    d3.select(this).style('stroke', '#475569').style('stroke-width', 0.5);
                    d3.select('#globeTooltip').classed('show', false);
                })
                .on('click', (e, d) => {
                    const c = d.properties.guest_count || 0, n = d.properties.name || d.properties.NAME || d.properties.ADMIN || 'Unknown';
                    const statuses = [[11,'Top destination!','#2d5a8c'],[6,'Popular destination','#2d5a8c'],[2,'Growing interest','#4a7bb5'],[1,'First visitor!','#4a7bb5'],[0,'No visitors yet','#6b6b6b']];
                    const [,text,color] = statuses.find(([min]) => c >= min);
                    document.getElementById('countryName').textContent = n;
                    document.getElementById('countryVisitors').textContent = c;
                    Object.assign(document.getElementById('countryStatus').style, {color});
                    document.getElementById('countryStatus').textContent = text;
                    document.getElementById('countryInfoPanel').classList.add('show');
                });
            
            svg.call(d3.drag().on('drag', e => {
                const r = projection.rotate();
                projection.rotate([r[0] + e.dx/25, r[1] - e.dy/25]);
                g.selectAll('path').attr('d', path);
            }).on('end', () => {
                clearInterval(rotationInterval);
                rotationInterval = setInterval(() => {
            const r = projection.rotate();
                    projection.rotate([r[0] + 0.2, r[1]]);
            g.selectAll('path').attr('d', path);
                }, 30);
            }));
            
            rotationInterval = setInterval(() => {
                const r = projection.rotate();
                projection.rotate([r[0] + 0.2, r[1]]);
                g.selectAll('path').attr('d', path);
            }, 30);
        }

        function createChart(id, metric) {
            charts[id]?.destroy();
            const players = [...new Set(catanData.map(r => r.player))].sort();
            const seasons = sortSeasons([...new Set(catanData.map(r => r.season))]);
            const grouped = {};
            catanData.forEach(r => {
                (grouped[r.season] = grouped[r.season] || {})[r.player] = (grouped[r.season][r.player] || 0) + r[metric];
            });
            
            charts[id] = new Chart(document.getElementById(id), {
                type: 'line',
                data: {
                    labels: seasons,
                    datasets: players.map(p => ({
                        label: p,
                        data: seasons.map(s => grouped[s][p] || 0),
                        borderColor: getPlayerColor(p, players),
                        backgroundColor: getPlayerColor(p, players) + '20',
                        tension: 0,
                        stepped: true,
                        fill: false,
                        pointRadius: 4
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top', labels: { usePointStyle: true, padding: 20 } } },
                    scales: { x: { grid: { color: 'rgba(42,67,101,0.12)' } }, y: { grid: { color: 'rgba(42,67,101,0.12)' } } }
                }
            });
        }
        
        async function loadData() {
            try {
                catanData = await fetch('data/catan_stats.json').then(r => r.json());
                
                createChart('titlesChart', 'titles');
                createChart('pointsChart', 'points');
                
                const stats = {
                    seasons: new Set(catanData.map(r => r.season)).size,
                    titles: catanData.reduce((s, r) => s + r.titles, 0),
                    points: catanData.reduce((s, r) => s + r.points, 0),
                    countries: 0
                };
                
                // Load country count from guest data
                fetch('data/guest_counts.json')
                    .then(r => r.json())
                    .then(data => {
                        stats.countries = Object.keys(data.countries || {}).length;
                        document.getElementById('summary-stats').innerHTML = 
                            ['Seasons', 'Total Titles', 'Total Points', 'Country Count']
                            .map((label, i) => `<div class="stat-item"><div class="stat-value">${Object.values(stats)[i]}</div><div class="stat-label">${label}</div></div>`)
                            .join('');
                    })
                    .catch(() => {
                        document.getElementById('summary-stats').innerHTML = 
                            ['Seasons', 'Total Titles', 'Total Points', 'Country Count']
                            .map((label, i) => `<div class="stat-item"><div class="stat-value">${Object.values(stats)[i]}</div><div class="stat-label">${label}</div></div>`)
                            .join('');
                    });
                
                await initGlobe();
                document.getElementById('closeCountryInfo').onclick = () => document.getElementById('countryInfoPanel').classList.remove('show');
            } catch(e) {
                document.getElementById('summary-stats').innerHTML = 'Could not load statistics.';
            }
        }
        
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>